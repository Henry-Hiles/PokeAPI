<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" asp-append-version="true" href="/site.css" />
    <title>PokéAPI</title>
</head>

<body>
    <div>
        <h1>PokeAPI</h1>

        <label for="select">Region</label>

        <select id="select">
            <option selected>All Pokemon</option>
        </select>

        <h3>Pokémon</h3>

        <div id="cards">
        </div>
        <button class="see-more" id="more">See More</button>

        <template>
            <div class="pokemon">
                <img data-image class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                <h2 data-name>
                    <div class="skeleton skeleton-text"></div>
                </h2>
                <div data-types>
                    <img class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                    <img class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                </div>
            </div>
        </template>
        <script>
            const pokemonCount = 12
            const cards = document.querySelector( "#cards" )
            const more = document.querySelector( "#more" )
            const template = document.querySelector( "template" )
            let currentOffset = 0;
            const addPokemon = async ( offset ) => {
                for ( let i = 0; i < pokemonCount; i++ ) {
                    cards.append( template.content.cloneNode( true ) )
                }
                const response = await fetch( `https://pokeapi.co/api/v2/pokemon?limit=${pokemonCount}&offset=${offset}` )
                const result = await response.json()
                const addCard = async i => {
                    const pokemonResponse = await fetch( result.results[i].url )
                    const pokemon = await pokemonResponse.json()
                    const card = cards.children.item( offset + i )
                    const img = card.querySelector( "[data-image]" )
                    img.src = pokemon.sprites.front_default
                    img.addEventListener( 'load', () => img.classList.remove( "skeleton" ) )
                    card.querySelector( "[data-name]" ).textContent = pokemon.name

                    const types = card.querySelector( "[data-types]" )
                    for ( let i = 0; i < pokemon.types.length; i++ ) {
                        const type = pokemon.types[i];
                        const img = card.querySelector( "[data-types]" ).children.item( i )
                        img.src = ( type.type.name == "psychic" ) ? "https://pokeguide.neocities.org/Pic/physicicon.png" : `https://pokeguide.neocities.org/Pic/${type.type.name}icon.png`
                    }
                    types.childNodes.forEach( type => type.complete && type.naturalHeight !== 0 ? type.classList.remove( "skeleton" ) : type.addEventListener( 'load', () => type.classList.remove( "skeleton" ) ) )
                }

                for ( let i = 0; i < pokemonCount; i++ ) await addCard( i )
                if ( !result.next ) more.classList.add( "hidden" )
            }

            addPokemon( currentOffset )

            more.addEventListener( "click", () => {
                addPokemon( currentOffset )
                currentOffset += pokemonCount
            } )

            const checkForMorePokemon = async () => {
                const more = document.querySelector( "#more" );
                const moreOffset = more.offsetTop + more.clientHeight;
                const pageOffset = window.pageYOffset + window.innerHeight;

                if ( pageOffset > moreOffset - 20 ) {
                    addPokemon( currentOffset )
                    currentOffset += pokemonCount
                }
            };

            document.addEventListener( "scroll", () => checkForMorePokemon() );
        </script>
</body>

</html>
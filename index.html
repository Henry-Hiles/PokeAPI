<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" asp-append-version="true" href="/site.css" />
    <title>PokéAPI</title>
</head>

<body>
    <div>
        <h1>PokeAPI</h1>

        <label for="select">Region</label>

        <select id="select">
            <option selected>All Pokemon</option>
        </select>

        <h3>Pokémon</h3>

        <div id="cards"></div>
        <button class="see-more" id="more">See More</button>

        <template>
            <div class="pokemon">
                <img data-image class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                <h2 data-name>
                    <div class="skeleton skeleton-text"></div>
                </h2>
                <div data-types>
                    <div>
                        <img class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                        <span class="skeleton skeleton-text type-name"></span>
                    </div>
                    <div>
                        <img class="skeleton" src="https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png">
                        <span class="skeleton skeleton-text type-name"></span>
                    </div>
                </div>
            </div>
        </template>
        <script>
            const pokemonCount = 12
            const cards = document.querySelector( "#cards" )
            const more = document.querySelector( "#more" )
            const template = document.querySelector( "template" )
            let currentOffset = 0;
            const addPokemon = async () => {
                const offset = currentOffset
                currentOffset += pokemonCount
                for ( let i = 0; i < pokemonCount; i++ ) {
                    cards.append( template.content.cloneNode( true ) )
                }
                const response = await fetch( `https://pokeapi.co/api/v2/pokemon?limit=${pokemonCount}&offset=${offset}` )
                const result = await response.json()
                const addCard = async i => {
                    const pokemonResponse = await fetch( result.results[i].url )
                    const pokemon = await pokemonResponse.json()
                    const card = cards.children[offset + i]
                    const img = card.querySelector( "[data-image]" )
                    const types = card.querySelector( "[data-types]" )
                    img.addEventListener( 'load', () => img.classList.remove( "skeleton" ) )
                    img.src = pokemon.sprites.front_default
                    card.querySelector( "[data-name]" ).textContent = pokemon.name

                    //console.log( types.children )

                    if ( pokemon.types.length == 1 ) {
                        types.children[1].remove()
                    }

                    pokemon.types.forEach( ( type, i ) => {
                        const typeElement = types.children[i]
                        const typeName = type.type.name
                        const typeImage = typeElement.children[0]
                        typeImage.addEventListener( 'load', () => typeImage.classList.remove( "skeleton" ) )
                        typeImage.src = `images/${typeName}.png`
                        const typeNameElement = typeElement.children[1]
                        typeNameElement.innerText = typeName
                        typeNameElement.classList.remove( "skeleton", "skeleton-text" )
                    } );
                }

                [...Array( pokemonCount )].forEach( ( _, i ) => addCard( i ) )
                if ( !result.next ) more.classList.add( "hidden" )
            }

            addPokemon()

            more.addEventListener( "click", addPokemon )

            const checkForMorePokemon = async () => {
                const more = document.querySelector( "#more" )
                const moreOffset = more.offsetTop + more.clientHeight
                const pageOffset = window.pageYOffset + window.innerHeight

                if ( pageOffset > moreOffset - 20 ) addPokemon()
            }

            document.addEventListener( "scroll", checkForMorePokemon )
        </script>
</body>

</html>